{% extends "home.html" %}

{% block content %}
<style>
/* WhatsApp-style chat for users */
.chat-wrap {max-width: 800px; margin: 20px auto; background: var(--card); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: hidden; border:1px solid var(--ring)}
.chat-header {background: var(--brand); color:#fff; padding: 12px 16px; font-weight: 700; display:flex; align-items:center; gap:10px}
.chat-header .title {font-size: 16px}
.chat-body {height: 65vh; overflow-y: auto; padding: 16px; background: var(--bg)}
.msg {display: inline-block; padding: 10px 14px; border-radius: 12px; margin: 6px 0; max-width: 70%; position: relative; font-size: 14px; border:1px solid rgba(0,0,0,.06)}
.msg.me {background: #fff8ef; border-color: rgba(204,146,79,.25); margin-left: auto; display:block}
.msg.other {background: #ffffff; display:block}
.msg .meta {font-size: 11px; color: var(--muted); margin-left: 8px}
.chat-input {display:flex; gap: 8px; padding: 10px; background: #f7f7f7; border-top: 1px solid rgba(0,0,0,.08)}
.chat-input input {flex:1; border: 1px solid rgba(0,0,0,.15); border-radius: 20px; padding: 10px 14px}
.chat-input input:focus{outline: none; box-shadow: 0 0 0 3px var(--ring); border-color: var(--brand)}
.chat-input button {background: var(--brand); color:#fff; border:none; border-radius: 20px; padding: 10px 16px; font-weight:700}
</style>

<div class="chat-wrap">
  <div class="chat-header">
    <div class="title">User Chat • Request #{{ req.id }} • {{ req.hospital_name }}</div>
  </div>
  <div id="chat-messages" class="chat-body"></div>
  <div class="chat-input">
    <input type="text" id="chat-message" placeholder="Type a message">
    <button id="chat-message-send" type="button">Send</button>
  </div>
</div>

<script>
const requestId = "{{ req.id }}";
const senderId = "{{ user.userid }}";

const socketUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + "/ws/chat/" + requestId + "/";
const chatSocket = new WebSocket(socketUrl);

chatSocket.onopen = () => console.log("WS open", socketUrl);
chatSocket.onerror = (e) => console.error("WS error", e);
chatSocket.onclose = () => console.warn("WS closed");

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  if (data.type === "history") data.messages.forEach(m => appendMessage(m));
  if (data.type === "chat") appendMessage(data.message);
};

function appendMessage(m){
  const box = document.getElementById('chat-messages');
  const isMe = String(m.sender_id) === String(senderId);
  const p = document.createElement('div');
  p.className = 'msg ' + (isMe ? 'me' : 'other');
  p.innerHTML = (isMe
      ? `${m.message} <span class="meta">${m.timestamp||''}</span>`
      : `<strong>${m.sender}:</strong> ${m.message} <span class="meta">${m.timestamp||''}</span>`);
  box.appendChild(p);
  box.scrollTop = box.scrollHeight;
}

const input = document.getElementById('chat-message');
const btn = document.getElementById('chat-message-send');

function send(){
  const message = input.value;
  if(message.trim()){ chatSocket.send(JSON.stringify({message})); input.value=''; }
}
btn.onclick = send;
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
</script>
{% endblock %}
